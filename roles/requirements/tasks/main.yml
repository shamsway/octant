---
- name: Set a hostname
  become: true
  ansible.builtin.hostname:
    name: "{{ inventory_hostname.split('.')[0] }}"
    use: debian

# Setup hashi service account
- name: Ensure group {{ group }} exists
  ansible.builtin.group:
    name: "{{ group }}"
    state: present
    gid: "{{ gid }}"

- name: Add {{ user }} user
  ansible.builtin.user:
    name: "{{ user }}"
    uid: "{{ uid }}"
    state: present
    system: true
    # shell: /usr/bin/false
    shell: /bin/bash
    home: "{{ datadir }}/home"
    groups:
      - sudo
      - "{{ group }}"

- name: Allow {{ user }} to have passwordless sudo
  ansible.builtin.lineinfile:
    dest: /etc/sudoers.d/{{ user }}
    state: present
    create: true
    line: "{{ user }} ALL=(ALL) NOPASSWD: ALL"

# Setup Admin account
- name: Create user {{ admin_user }}
  ansible.builtin.user:
    name: "{{ admin_user }}"
    shell: /bin/bash
    state: present
    groups:
      - sudo
      - "{{ group }}"

- name: Allow {{ admin_user }} to have passwordless sudo
  ansible.builtin.lineinfile:
    dest: /etc/sudoers.d/{{ admin_user }}
    state: present
    create: true
    line: "{{ admin_user }} ALL=(ALL) NOPASSWD: ALL"

- name: Set up authorized keys for {{ admin_user }}
  ansible.posix.authorized_key:
    user: "{{ admin_user }}"
    key: "{{ lookup('file', user_public_key) }}"

# Complete requirements
- name: Check if {{ user }} home folder exists
  ansible.builtin.file:
    path: "{{ datadir }}/home"
    state: directory
    owner: "{{ user }}"
    group: "{{ group }}"

- name: Ensure {{ user }} is a member of systemd-journal group
  ansible.builtin.user:
    name: "{{ user }}"
    groups: systemd-journal
    append: true

- name: Create user systemd configuration directory
  ansible.builtin.file:
    path: "{{ datadir }}/home/.config/systemd/user/"
    state: directory
    mode: "0700"
    owner: "{{ user }}"
    group: "{{ group }}"

- name: Verify folder presence and ownership
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ user }}"
    group: "{{ group }}"
    mode: "0755"
  loop: "{{ volumes }}"

- name: Add polkit policy for machinectl
  become: true
  ansible.builtin.copy:
    dest: /etc/polkit-1/rules.d/60-machinectl-fast-user-auth.rules
    content: |
      polkit.addRule(function(action, subject) {
          if(action.id == "org.freedesktop.machine1.host-shell" && subject.isInGroup("{{ group }}")) {
              return polkit.Result.YES;
          }
      });
    owner: root
    group: root
    mode: "0644"
  register: polkit_rule

- name: Restart polkit service
  ansible.builtin.service:
    name: polkit
    state: restarted
  when: polkit_rule.changed

# Configure DNS
- name: Configure dnsmasq for DNS servers
  when: dnsserver is defined and dnsserver
  block:
    - name: Ensure resolv.conf contains only the specified line
      ansible.builtin.copy:
        content: nameserver 127.0.0.1
        dest: /etc/resolv.conf

    - name: Install dnsmasq
      ansible.builtin.package:
        name: dnsmasq
        state: present

    - name: Check if dnsmasq configuration file exists
      ansible.builtin.stat:
        path: /etc/dnsmasq.d/shamsway-server.conf
      register: dnsmasq_conf

    - name: Create dnsmasq server configuration file if it doesn't exist
      ansible.builtin.copy:
        dest: /etc/dnsmasq.d/shamsway-server.conf
        content: |
          server=1.1.1.1
          server=8.8.8.8
          server=/.consul/127.0.0.1#8600
          server=/shamsway.net/127.0.0.1#8600
        owner: root
        group: root
        mode: "0644"
      when: not dnsmasq_conf.stat.exists

    - name: Restart dnsmasq if configuration file is newly created
      ansible.builtin.service:
        name: dnsmasq
        state: restarted
      when: not dnsmasq_conf.stat.exists

    - name: Ensure dnsmasq is running
      ansible.builtin.service:
        name: dnsmasq
        state: started
        enabled: true

- name: Configure dnsmasq for DNS clients
  when: dnsserver is not defined or not dnsserver
  block:
    - name: Ensure resolv.conf contains only the specified line
      ansible.builtin.copy:
        content: nameserver 127.0.0.1
        dest: /etc/resolv.conf

    - name: Install dnsmasq
      ansible.builtin.package:
        name: dnsmasq
        state: present

    - name: Check if dnsmasq configuration file exists
      ansible.builtin.stat:
        path: /etc/dnsmasq.d/shamsway-client.conf
      register: dnsmasq_conf

    - name: Create dnsmasq client configuration file if it doesn't exist
      ansible.builtin.copy:
        dest: /etc/dnsmasq.d/shamsway-client.conf
        content: |
          server=192.168.252.6
          server=192.168.252.7
          server=1.1.1.1
        owner: root
        group: root
        mode: "0644"
      when: not dnsmasq_conf.stat.exists

    - name: Restart dnsmasq if configuration file is newly created
      ansible.builtin.service:
        name: dnsmasq
        state: restarted
      when: not dnsmasq_conf.stat.exists

    - name: Ensure dnsmasq is running
      ansible.builtin.service:
        name: dnsmasq
        state: started
        enabled: true

- name: Update all packages
  ansible.builtin.include_role:
    name: server-update

- name: Install required packages
  ansible.builtin.apt:
    name:
      - acl
      - apt-transport-https
      - build-essential
      - automake
      - autoconf
      - ca-certificates
      - dnsmasq
      - systemd-container
      - curl
      - wget
      - unzip
      - gnupg
      - lsb-release
      - software-properties-common
      - net-tools
      - htop
      - bind9-dnsutils
      - iptables-persistent
      - man
      - golang
      - podman
      - podman-compose
      - git
      - crun
      - cockpit
      - cockpit-podman
      - cockpit-pcp
      - cockpit-doc
    state: present

# Override tailscale advertised local routes
- name: Create systemd service file for internal network routes
  ansible.builtin.copy:
    dest: /etc/systemd/system/internal-network-routes.service
    content: |
      [Unit]
      Description=Set routing rules for internal networks
      After=network.target

      [Service]
      Type=oneshot
      ExecStart=/bin/bash -c '{% for subnet in internal_subnets %}if ! ip rule show to {{ subnet }} >/dev/null 2>&1; then /sbin/ip rule add to {{ subnet }} priority 2500 lookup main; fi;{% endfor %}'
      RemainAfterExit=yes

      [Install]
      WantedBy=multi-user.target
    owner: root
    group: root
    mode: "0644"
  when: region == "home"

- name: Reload systemd routes
  ansible.builtin.systemd:
    daemon_reload: true
    name: internal-network-routes
    state: started
    enabled: true

- name: Attempt to check Tailscale IP address
  ansible.builtin.command:
    cmd: tailscale ip -4
  register: tailscale_ip_output
  changed_when: false
  ignore_errors: true

- name: Set Tailscale status as a variable
  ansible.builtin.set_fact:
    tailscale_installed: "{{ tailscale_ip_output.rc == 0 and tailscale_ip_output.stdout != '' }}"

# - name: Set Tailscale IP address as a variable
#   ansible.builtin.set_fact:
#     tailscale_ip: "{{ tailscale_ip_output.stdout }}"
#   when: tailscale_installed and tailscale_ip_output.stdout != ''

- name: Tailscale status
  ansible.builtin.debug:
    msg: "Tailscale instaled: {{ tailscale_installed }}"
#msg: "Tailscale IP: {{ tailscale_installed | ternary(tailscale_ip, 'No IP assigned') }}"

# Install tailscale
- name: Install tailscale
  become: true
  ansible.builtin.shell: |
    curl -fsSL https://tailscale.com/install.sh | sh
  when: tailscale_installed == false

# Configure tailscale clients
- name: Bring up tailscale client
  become: true
  ansible.builtin.shell: |
    tailscale up --reset --authkey="{{ lookup('env', 'TAILSCALE_CLOUD_KEY') }}" --accept-routes
  when: tailscale_advertisements is not defined | default(false, true)

# Configure Tailscale Routers
- name: Configure Tailscale Routers
  when: tailscale_advertisements is defined | default(false, true)
  block:
    # Configure tailscale routers
    - name: Configure MSS clamping for Tailscale
      ansible.builtin.command:
        cmd: iptables -t mangle -A FORWARD -i tailscale0 -o eth0 -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
      when: tailscale_advertisements is defined | default(false, true)

    - name: Save iptables rules
      ansible.builtin.shell: /usr/sbin/iptables-save > /etc/iptables/rules.v4

    - name: Bring up tailscale router
      become: true
      ansible.builtin.shell: |
        tailscale up --reset --authkey="{{ lookup('env', 'TAILSCALE_CLOUD_KEY') }}" --advertise-routes={{ tailscale_advertisements }} --snat-subnet-routes=false --accept-routes
        iptables -t mangle -A FORWARD -i tailscale0 -o eth0 -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu

# - name: Configure routing advertisement
#   become: true
#   ansible.builtin.command:
#     cmd: tailscale set --advertise-routes={{ tailscale_advertisements }}
#   when: tailscale_advertisements is defined | default(false, true)

- name: Disable Tailscale DNS
  become: true
  ansible.builtin.command:
    cmd: tailscale set --accept-dns=false

- name: Disable Tailscale SSH
  become: true
  ansible.builtin.command:
    cmd: tailscale set --ssh=false

- name: Get Tailscale IP address
  ansible.builtin.command:
    cmd: tailscale ip -4
  register: tailscale_ip_output
  changed_when: false

- name: Set Tailscale IP address as a variable
  ansible.builtin.set_fact:
    tailscale_ip: "{{ tailscale_ip_output.stdout }}"

# Use the tailscale_ip variable in other tasks
- name: Print Tailscale IP address
  ansible.builtin.debug:
    msg: "Tailscale IP address: {{ tailscale_ip }}"

# - name: Add IP address of all hosts to all hosts
#   ansible.builtin.lineinfile:
#     dest: /etc/hosts
#     regexp: .*{{ item }}$
#     line: "{{ hostvars[item].ansible_ssh_host }} {{ item }}"
#     state: present
#   when: hostvars[item].ansible_ssh_host is defined
#   with_items: "{{ groups.all }}"

- name: Add hostname to /etc/hosts
  vars:
    comment: "# added by ansible"
  ansible.builtin.lineinfile:
    dest: /etc/hosts
    regexp: 127[.]0[.]0[.]1.*
    line: 127.0.0.1 localhost.localdomain localhost {{ domain }}.{{ datacenter }}.consul {{ domain }}.{{ tld }} {{ ansible_hostname }} {{ comment }}
    state: present
    owner: root
    group: root
    mode: "0755"

- name: Disable ICMP Redirect Acceptance
  ansible.posix.sysctl:
    name: net.ipv4.conf.all.accept_redirects
    value: "0"
    sysctl_set: true
    reload: true

- name: Disable ICMP Redirect Sending
  ansible.posix.sysctl:
    name: net.ipv4.conf.all.send_redirects
    value: "0"
    sysctl_set: true
    reload: true

- name: Fix number of file opened
  ansible.builtin.copy:
    src: nofile.conf
    dest: /etc/security/limits.d/90-nofile.conf
    mode: "0644"

- name: Daemon Reload
  ansible.builtin.systemd:
    daemon_reload: true

- name: Enable cockpit service
  ansible.builtin.systemd_service:
    name: cockpit
    enabled: true

- name: Disable cloud-init
  ansible.builtin.command: touch /etc/cloud/cloud-init.disabled
    args:
      creates: /etc/cloud/cloud-init.disabled
  

- name: Conditionally reboot the machine based on the 'reboot' inventory variable
  ansible.builtin.reboot: {}
  when: hostvars[inventory_hostname].reboot | default(false) | bool
